<!DOCTYPE html>
<html>
<head>
  <title>Index</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/jquery.mobile.css" />
  <link rel="stylesheet" href="css/custom.css" />
  <script src="js/jquery.js"></script>
  <script src="js/jquery.mobile.js"></script>
  <script src="js/jquery.resizecrop.min.js"></script>
  <script src="cordova.js"></script>
  <script src="js/app.js"></script>
  <script src="cdv-plugin-fb-connect.js"></script>
  <script src="facebook_js_sdk.js"></script>
  <script src="js/moment.min.js"></script>
  <script type="text/javascript">
  document.addEventListener('deviceready', init, false);
  // document.addEventListener('load', init);

  function init() {
    console.log('init');
    try {
      FB.init({
        appId: "366089376758944",
        nativeInterface: CDV.FB,
        useCachedDialogs: false,

      });
      FB.getLoginStatus(function(response) {
        if (response.status === 'connected') {
          console.log('connesso');
         var facebook_id = response.authResponse.userID;
         console.log(facebook_id);
          if (!isUserInStorage()) {
            console.log('user not in storage');
            $.getJSON(endpoint + "/users", {
              facebook_id: facebook_id
            }, function(data) {
              if (data) {
                user.id = data[0]._id;
                console.log(user.id);
                saveUserStorage(user.id);
                $.mobile.changePage('parties.html');
                // $(location).attr('href', 'parties.html');
              }
            });
          } else {
            user.id=window.localStorage.getItem("pm_user_id");    
            console.log('user in storage' + user.id);
            // $(location).attr('href', 'parties.html');
            $.mobile.changePage('parties.html');
          }
        } else {
          console.log('non connesso');
          $(location).attr('href', 'connect.html');
        }
      });
    } catch (e) {
      alert(e);
    }
  }
  </script>
</head>
<body>
<div data-role='page' data-theme='a'></div>
</body>
</html>
